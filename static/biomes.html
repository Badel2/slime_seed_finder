<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>slime_seed_finder playground</title>
        <style>
            body {
                background-color: #eee;
            }
            input {
                font-family: monospace;
            }
            textarea {
                font-family: monospace;
            }
        </style>
        <script src="json-stringify-pretty-compact.js"></script>
        <script src="common.js"></script>
        <script src="fragment_map.js"></script>
    </head>
    <body>
        <a href="https://github.com/Badel2/slime_seed_finder">SLIME SEED FINDER</a>
        <strong>Under construction.</strong><br>
        <div style="width: 100%;">
        <div style="float: left; width: 50%;">
            <canvas id="demo" width="512" height="512"></canvas>
            <div id="position_info"></div>
            <div>
                <button onClick="Game.zoomBy(0.8)">ZOOM -</button>
                <button onClick="Game.zoomBy(1.25)">ZOOM +</button>
                <input id="center_x" size=2>
                <input id="center_z" size=2>
                <button id="center_button">CENTER</button>
                <input type="range" min="0" max="7" value="7" class="slider" id="gridSize">
            </div>
        </div>
        <div style="float: right; width: 50%">
          <textarea id="selection_output" class="code" rows="20" style="width: 45%;"></textarea>
          <textarea id="output_textarea" class="code" rows="20" style="width: 45%;" readonly>Found 48-bit seeds will appear here.</textarea>
          <textarea id="num_candidates" class="code" rows="1" readonly></textarea>
          <button onClick="load_selection()">LOAD JSON</button>
          <button onClick="countCandidates()">ESTIMATE RUNTIME</button>
          <button id="comphdl_start" onClick="runGui()">RUN!</button>
        </div>
        </div>

        <div style="clear: both;"></div>
        <div>
          <br>
          Once you have found the lower 48 bits of the seed, you can find the full 64 bit seed by
          assuming that it was generated by Minecraft when the seed field is left empty
          (using Rand.nextLong()). <br>
          <input type="text" id="seed48" placeholder="Enter the lowest 48 bits of the seed here (in decimal)">
          <br>
          <textarea id="output_extend48" class="code" rows="3" readonly>Found 64-bit seeds will appear here.</textarea>
        </div>
          
        <script type="text/javascript" src="wasm_gui.js"></script>
        <script>
            if (window.Worker) {
                var myWorker = new Worker("worker.js");
            }
            function runGui() {
                    var seltextarea = document.getElementById('selection_output');
                    var s = JSON.parse(seltextarea.value);
                    var chunks = s.slime_chunks;
                    var no_chunks = s.slime_chunks_not;
                    var outta = document.getElementById('output_textarea');
                    outta.value = "Calculating...";
                    if (window.Worker) {
                        myWorker.postMessage({ chunks: chunks, no_chunks: no_chunks });
                        console.log('Message posted to worker');
                        myWorker.onmessage = function(e) {
                            outta.value = e.data;
                            console.log('Got message from worker');
                        };
                    } else {
                        Rust.wasm_gui.then( function( wasmgui ) {
                            // TODO: check if a thread is already running and kill it
                            outta.value = wasmgui.slime_seed_finder(chunks, no_chunks);
                        }, function( err ) {
                            console.err(err);
                        });
                    }
            }

            // Generate fragment
            // This function should return a promise, which is interpreted as
            // a HTML canvas
            function generateFragmentB(fx, fy) {
                return Rust.wasm_gui.then( function( wasmgui ) {
                    var seed = 1234; // TODO
                    console.log("Generating fragment: " + fx + ", " + fy);
                    var rvec = wasmgui.generate_fragment(fx, fy, seed);
                    console.log("Copying to canvas: " + fx + ", " + fy);
                    // Create off-screen canvas
                    var c = document.createElement('canvas');
                    c.width = FRAG_SIZE;
                    c.height = FRAG_SIZE;
                    var ctx = c.getContext('2d');
                    // Generate fragment
                    var imageData = ctx.createImageData(FRAG_SIZE, FRAG_SIZE);
                    //imageData.data = rvec; // please
                    for(var i=0; i<FRAG_SIZE*FRAG_SIZE*4; i++) {
                        imageData.data[i] = rvec[i];
                    }
                    /*
                    for(var x=0; x<FRAG_SIZE; x++) {
                        for(var y=0; y<FRAG_SIZE; y++) {
                            var pixel = rvec[i];
                            var i = ((y * FRAG_SIZE) + x) * 4;
                            var colorIndices = [i, i+1, i+2, i+3];

                            var redIndex = colorIndices[0];
                            var greenIndex = colorIndices[1];
                            var blueIndex = colorIndices[2];
                            var alphaIndex = colorIndices[3];

                            imageData.data[redIndex] = pixel[0];
                            imageData.data[greenIndex] = pixel[1];
                            imageData.data[blueIndex] = pixel[2];
                            imageData.data[alphaIndex] = pixel[3];
                        }
                    }
                    */
                    ctx.putImageData(imageData, 0, 0);
                    return c;
                }, function( err ) {
                    console.err(err);
                });
            }

            map.generateFragment = generateFragmentB;
        </script>
    </body>
</html>
