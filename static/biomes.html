<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>slime_seed_finder playground</title>
        <style>
            body {
                background-color: #eee;
            }
            input {
                font-family: monospace;
            }
            textarea {
                font-family: monospace;
            }
        </style>
        <script src="json-stringify-pretty-compact.js"></script>
        <script src="common.js"></script>
        <script src="fragment_map.js"></script>
    </head>
    <body>
        <a href="https://github.com/Badel2/slime_seed_finder">SLIME SEED FINDER</a>
        <strong>Under construction.</strong><br>
        <div style="width: 100%;">
        <div style="float: left; width: 50%;">
            <input type="text" id="worldSeed" placeholder="Enter world seed">
            <canvas id="demo" width="512" height="512"></canvas>
            <div id="position_info"></div>
            <div>
                <button onClick="Game.zoomBy(0.8)">ZOOM -</button>
                <button onClick="Game.zoomBy(1.25)">ZOOM +</button>
                <input id="center_x" size=6>
                <input id="center_z" size=6>
                <button id="center_button">CENTER</button>
                <input type="range" min="0" max="9" value="9" class="slider" id="gridSize">
            </div>
        </div>
        <div style="float: right; width: 50%">
          <textarea id="selection_output" class="code" rows="20" style="width: 45%;"></textarea>
          <textarea id="output_textarea" class="code" rows="20" style="width: 45%;" readonly>Found 48-bit seeds will appear here.</textarea>
          <textarea id="num_candidates" class="code" rows="1" readonly></textarea>
          <button onClick="load_selection()">LOAD JSON</button>
          <button onClick="countCandidates()">ESTIMATE RUNTIME</button>
          <button id="comphdl_start" onClick="runGui()">RUN!</button>
        </div>
        </div>

        <div style="clear: both;"></div>
        <div>
          <br>
          Once you have found the lower 48 bits of the seed, you can find the full 64 bit seed by
          assuming that it was generated by Minecraft when the seed field is left empty
          (using Rand.nextLong()). <br>
          <input type="text" id="seed48" placeholder="Enter the lowest 48 bits of the seed here (in decimal)">
          <br>
          <textarea id="output_extend48" class="code" rows="3" readonly>Found 64-bit seeds will appear here.</textarea>
        </div>
          
        <script type="text/javascript" src="wasm_gui.js"></script>
        <script>
            // Hacks to make workers return promises
            // https://codeburst.io/promises-for-the-web-worker-9311b7831733
            const resolves = {}
            const rejects = {}
            let globalMsgId = 0

            // Activate calculation in the worker, returning a promise
            function sendMsg(payload, worker){
              const msgId = globalMsgId++
              const msg = {
                id: msgId,
                payload
              }

              return new Promise(function (resolve, reject) {
                // save callbacks for later
                resolves[msgId] = resolve
                rejects[msgId] = reject

                worker.postMessage(msg)
              })
            }

            // Handle incoming calculation result
            function handleMsg(msg) {
              const {id, err, payload} = msg.data

              if (payload) {
                const resolve = resolves[id]
                if (resolve) {
                  resolve(payload)
                }
              } else {
                // error condition
                const reject = rejects[id]
                if (reject) {
                    if (err) {
                      reject(err)
                    } else {
                      reject('Got nothing')
                    }
                }
              }

              // purge used callbacks
              delete resolves[id]
              delete rejects[id]
            }

            // Wrapper class
            function Wrapper() {
                this.worker = new Worker('./worker_b.js')
                this.worker.onmessage = handleMsg
            }
            Wrapper.prototype.sendMsg = function(payload) {
                return sendMsg(payload, this.worker);
            }

            const work1 = new Wrapper();

            // Generate fragment
            // This function should return a promise, which is interpreted as
            // a HTML canvas
            function generateFragmentB(fx, fy) {
                if (window.Worker) {
                    var ws = document.getElementById('worldSeed');
                    // Since js doesnt support 64 bit ints, we just pass
                    // the string to the Rust code, it will be parsed there
                    var seed = ws.value;
                    return work1.sendMsg({ fx: fx, fy: fy, seed: seed, FRAG_SIZE: FRAG_SIZE }).then(function(e) {
                        console.log("Copying to canvas: " + fx + ", " + fy);
                        // Create off-screen canvas
                        var c = document.createElement('canvas');
                        c.width = FRAG_SIZE;
                        c.height = FRAG_SIZE;
                        var ctx = c.getContext('2d');
                        // Generate fragment
                        var imageData = ctx.createImageData(FRAG_SIZE, FRAG_SIZE);
                        //imageData.data = rvec; // please
                        for(var i=0; i<FRAG_SIZE*FRAG_SIZE*4; i++) {
                            imageData.data[i] = e.rvec[i];
                        }
                        ctx.putImageData(imageData, 0, 0);
                        return c;
                    });
                } else {
                    return Rust.wasm_gui.then( function( wasmgui ) {
                        var ws = document.getElementById('worldSeed');
                        // Since js doesnt support 64 bit ints, we just pass
                        // the string to the Rust code, it will be parsed there
                        var seed = ws.value;
                        console.log("Seed: " + seed);
                        console.log("Generating fragment: " + fx + ", " + fy);
                        var rvec = wasmgui.generate_fragment(fx, fy, seed, FRAG_SIZE);
                        console.log("Copying to canvas: " + fx + ", " + fy);
                        // Create off-screen canvas
                        var c = document.createElement('canvas');
                        c.width = FRAG_SIZE;
                        c.height = FRAG_SIZE;
                        var ctx = c.getContext('2d');
                        // Generate fragment
                        var imageData = ctx.createImageData(FRAG_SIZE, FRAG_SIZE);
                        //imageData.data = rvec; // please
                        for(var i=0; i<FRAG_SIZE*FRAG_SIZE*4; i++) {
                            imageData.data[i] = rvec[i];
                        }
                        ctx.putImageData(imageData, 0, 0);
                        return c;
                    }, function( err ) {
                        console.err(err);
                    });
                }
            }

            map.generateFragment = generateFragmentB;

            var ws = document.getElementById('worldSeed');
            ws.oninput = function() {
                // Regenerate map when seed changes
                Game.clear();
            };
        </script>
    </body>
</html>
